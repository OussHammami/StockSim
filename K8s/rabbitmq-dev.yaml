apiVersion: apps/v1
kind: Deployment
metadata: { name: rabbitmq, namespace: stocksim }
spec:
  replicas: 1
  selector: { matchLabels: { app: rabbitmq } }
  template:
    metadata: { labels: { app: rabbitmq } }
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3-management
        ports:
        - { containerPort: 5672, name: amqp }
        - { containerPort: 15672, name: mgmt }
        env:
        - { name: RABBITMQ_DEFAULT_USER, value: stocksim }
        - { name: RABBITMQ_DEFAULT_PASS, value: stocksim }
        readinessProbe: { tcpSocket: { port: amqp }, initialDelaySeconds: 5, periodSeconds: 5 }
        livenessProbe:  { tcpSocket: { port: amqp }, initialDelaySeconds: 10, periodSeconds: 10 }
---
apiVersion: v1
kind: Service
metadata: { name: rabbitmq, namespace: stocksim }
spec:
  selector: { app: rabbitmq }
  ports:
  - { name: amqp, port: 5672, targetPort: 5672 }
  - { name: mgmt, port: 15672, targetPort: 15672 }
