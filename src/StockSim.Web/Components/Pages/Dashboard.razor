@page "/dashboard"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@implements IAsyncDisposable

@using MudBlazor
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Http.Connections
@using StockSim.Shared.Models 
@using StockSim.Web.Services
@inject IPortfolioService Portfolio
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Config
@inject StockSim.Web.Services.LastQuotesCache Cache
@inject IOrderPublisher OrderPublisher
@inject AuthenticationStateProvider Auth
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IOrderService OrderService

<MudText Typo="Typo.h5">Portfolio Dashboard</MudText>
<MudText Class="mb-2" Color="Color.Secondary">Live prices (simulated)</MudText>

<MudPaper Class="p-3 mb-3">
  <MudGrid>
    <MudItem xxl="3" lg="4" md="6" sm="12">
      <MudText Typo="Typo.h6">Trade</MudText>
      <MudTextField @bind-Value="_symbol" Label="Symbol" Immediate="true" />
      <MudNumericField @bind-Value="_qty" Label="Quantity" Min="1" />
      <MudStack Row="true" Spacing="2" Class="mt-2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Buy">Buy</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="Sell">Sell</MudButton>
      </MudStack>
      @if (!string.IsNullOrEmpty(_error)) { <MudAlert Severity="Severity.Error">@_error</MudAlert> }
    </MudItem>

    <MudItem xxl="3" lg="4" md="6" sm="12">
      <MudText Typo="Typo.h6">Account</MudText>
      <MudList T="string" Dense="true">
        <MudListItem T="string">Cash: @_snap.Cash.ToString("C")</MudListItem>
        <MudListItem T="string">Market Value: @_snap.MarketValue.ToString("C")</MudListItem>
        <MudListItem T="string">Unrealized PnL:
          <MudText Color="@(_snap.UnrealizedPnl>=0?Color.Success:Color.Error)">
             @_snap.UnrealizedPnl.ToString("C")
          </MudText>
        </MudListItem>
        <MudListItem T="string">Equity: @_snap.Equity.ToString("C")</MudListItem>
      </MudList>
    </MudItem>
  </MudGrid>
</MudPaper>
<MudPaper Class="p-3 mb-3">
    <MudText Typo="Typo.h6">Positions</MudText>

    <MudPaper Class="p-3 mb-3">
        <MudText Typo="Typo.h6">Recent Orders</MudText>

        @if (_orders.Count == 0)
        {
            <MudText Color="Color.Secondary">No orders.</MudText>
        }
        else
        {
            <MudTable Items="_orders">
                <HeaderContent>
                    <MudTh>Time</MudTh><MudTh>Symbol</MudTh><MudTh align="right">Qty</MudTh>
                    <MudTh align="right">Status</MudTh><MudTh align="right">Fill</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.SubmittedUtc.ToLocalTime().ToString("HH:mm:ss")</MudTd>
                    <MudTd>@context.Symbol</MudTd>
                    <MudTd Align="Right">@context.Quantity</MudTd>
                    <MudTd Align="Right">@context.Status</MudTd>
                    <MudTd Align="Right">@context.FillPrice?.ToString("F2")</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>

    @if (_snap.Positions.Count == 0)
    {
        <MudText Color="Color.Secondary">No positions.</MudText>
    }
    else
    {
        <MudTable Items="_snap.Positions">
            <HeaderContent>
                <MudTh>Symbol</MudTh>
                <MudTh align="right">Qty</MudTh>
                <MudTh align="right">Avg</MudTh>
                <MudTh align="right">Last</MudTh>
                <MudTh align="right">Unrealized</MudTh>
            </HeaderContent>
            <RowTemplate>
                @{
                    var sym = context.Symbol;
                    var last = _last.TryGetValue(sym, out var q) ? q.Price : 0m;
                    var upnl = context.Quantity * (last - context.AvgPrice);
                }
                <MudTd>@sym</MudTd>
                <MudTd Align="Right">@context.Quantity</MudTd>
                <MudTd Align="Right">@context.AvgPrice.ToString("F2")</MudTd>
                <MudTd Align="Right">@last.ToString("F2")</MudTd>
                <MudTd Align="Right">
                    <MudText Color="@(upnl >= 0 ? Color.Success : Color.Error)">@upnl.ToString("F2")</MudText>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>


@if (_quotes.Count == 0)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudTable Items="_quotes">
        <HeaderContent>
            <MudTh>Symbol</MudTh>
            <MudTh>Price</MudTh>
            <MudTh>Δ</MudTh>
            <MudTh>UTC</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Symbol">@context.Symbol</MudTd>
            <MudTd DataLabel="Price">@context.Price</MudTd>
            <MudTd DataLabel="Δ">
                <MudText Color="@(context.Change > 0 ? Color.Success : context.Change < 0 ? Color.Error : Color.Default)">
                    @((context.Change >= 0 ? "+" : "") + context.Change)
                </MudText>
            </MudTd>
            <MudTd DataLabel="UTC">@context.TimeUtc.ToString("HH:mm:ss")</MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private readonly List<Quote> _quotes = new();
    private HubConnection? _quoteshub; 
    private HubConnection? _ordersHub;
    private readonly Dictionary<string, Quote> _last = new(StringComparer.OrdinalIgnoreCase);
    private readonly List<StockSim.Web.Data.Trading.OrderEntity> _orders = new();
    private PortfolioSnapshot _snap = new();
    private string _symbol = "AAPL";
    private int _qty = 1;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        // 1) initial snapshot
        var client = HttpClientFactory.CreateClient("MarketFeed");
        var snap = await client.GetFromJsonAsync<Quote[]>("/api/quotes");
        var uid = await CurrentUserId();
        await LoadOrdersAsync(uid);
        if (snap is { Length: > 0 })
        {
            foreach (var q in snap) _last[q.Symbol] = q;
            _quotes.AddRange(snap.OrderBy(q => q.Symbol));
            _snap = await Portfolio.SnapshotAsync(uid, _last);
        }

        var ordersUrl = $"{NavigationManager.BaseUri.TrimEnd('/')}/hubs/orders?userId={Uri.EscapeDataString(uid)}";
        _ordersHub = new HubConnectionBuilder()
            .WithUrl(ordersUrl, o => { o.SkipNegotiation = true; o.Transports = HttpTransportType.WebSockets; })
            .WithAutomaticReconnect()
            .Build();


        _ordersHub.On<object>("order", async _ =>
        {
            await LoadOrdersAsync(uid);
            _snap = await Portfolio.SnapshotAsync(uid, _last);
            Snackbar.Add("Order filled", Severity.Success);
            await InvokeAsync(StateHasChanged);
        });

        await _ordersHub.StartAsync();

        // 2) live updates
        var baseUrl = Config["MarketFeed:BaseUrl"]!;
        _quoteshub = new HubConnectionBuilder()
            .WithUrl($"{baseUrl}/hubs/quotes", opt =>
            {
                // optional but robust in dev cross-origin scenarios
                opt.SkipNegotiation = true;
                opt.Transports = HttpTransportType.WebSockets;
            })
            .WithAutomaticReconnect()
            .Build();

        _quoteshub.On<Quote>("quote", async q =>
        {
            await InvokeAsync(async () =>
            {
                var i = _quotes.FindIndex(x => string.Equals(x.Symbol, q.Symbol, StringComparison.OrdinalIgnoreCase));
                if (i >= 0) _quotes[i] = q; else _quotes.Add(q);
                Cache.Upsert(q);
                _quotes.Sort((a, b) => string.Compare(a.Symbol, b.Symbol, StringComparison.OrdinalIgnoreCase));

                _last[q.Symbol] = q; 
                _snap = await Portfolio.SnapshotAsync(uid, _last);

                StateHasChanged();
            });
        });

        await _quoteshub.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_quoteshub is not null)
            await _quoteshub.DisposeAsync();
        if (_ordersHub is not null) 
            await _ordersHub.DisposeAsync();
    }

    private async Task<string> CurrentUserId()
    {
        var st = await Auth.GetAuthenticationStateAsync();
        return st.User.FindFirst("sub")?.Value
            ?? st.User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value
            ?? throw new InvalidOperationException("Not authenticated.");
    }

    private async Task Buy()
    {
        _error = null;
        var uid = await CurrentUserId();
        if (!_last.TryGetValue(_symbol, out _)) { _error = "Unknown symbol."; return; }

        OrderPublisher.Publish(new OrderCommand { UserId = uid, Symbol = _symbol, Quantity = _qty });
        Snackbar.Add("Order sent", Severity.Success);
    }

    private async Task Sell()
    {
        _error = null;
        var uid = await CurrentUserId();
        if (!_last.TryGetValue(_symbol, out _)) { _error = "Unknown symbol."; return; }

        OrderPublisher.Publish(new OrderCommand { UserId = uid, Symbol = _symbol, Quantity = -_qty });
        Snackbar.Add("Order sent", Severity.Success);
    }

    private async Task LoadOrdersAsync(string userId)
    {
        var rows = await OrderService.GetRecentAsync(userId);
        _orders.Clear();
        _orders.AddRange(rows);
    }

}
