@page "/dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using MudBlazor
@using StockSim.Domain.Orders
@using StockSim.Web.Services
@using static StockSim.Web.Services.TradingClient
@using static StockSim.Web.Services.PortfolioClient
@inject PortfolioClient PortfolioClient
@inject TradingClient TradingClient
@inject QuotesHubClient Quotes

<MudSnackbarProvider />
<MudPopoverProvider />
<MudText Typo="Typo.h5">Portfolio Dashboard</MudText>

<MudGrid Class="mt-2">
    <!-- Left column: everything except quotes -->
    <MudItem xxl="8" lg="8" md="12" sm="12">
        <MudPaper Class="p-3 mb-3">
            <MudGrid>
                <MudItem xxl="3" lg="4" md="6" sm="12">
                    <MudText Typo="Typo.h6">Trade</MudText>
                    <MudTextField T="string" @bind-Value="_form.Symbol" Label="Symbol" Required="true" />
                    <MudNumericField T="decimal" @bind-Value="_form.Quantity" Label="Quantity" Required="true" Min="0.0001m" />
                    <MudSelect T="OrderType"
                               Label="Type"
                               Value="_form.Type"
                               ValueChanged="OnTypeChanged"
                               ValueExpression="() => _form.Type">
                        <MudSelectItem Value="@(OrderType.Market)">Market</MudSelectItem>
                        <MudSelectItem Value="@(OrderType.Limit)">Limit</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="OrderSide" @bind-Value="_form.Side" Label="Side">
                        <MudSelectItem Value="@(OrderSide.Buy)">Buy</MudSelectItem>
                        <MudSelectItem Value="@(OrderSide.Sell)">Sell</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xxl="3" lg="4" md="6" sm="12">
                    <MudText Typo="Typo.h6">Account</MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem T="string">Cash: @(_summary?.Cash.ToString("0.##") ?? "-")</MudListItem>
                        <MudListItem T="string">Reserved: @(_summary?.ReservedCash.ToString("0.##") ?? "-")</MudListItem>


                        @if (_form.Type == OrderType.Limit)
                        {
                            <MudNumericField T="decimal?" @bind-Value="_form.LimitPrice" Label="Limit price" Min="0" />
                        }
                        <MudStack Row="true" Spacing="2" Class="mt-3">
                            <MudNumericField T="decimal" @bind-Value="_deposit" Min="0" Label="Deposit amount" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DepositAsync">Deposit</MudButton>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" Class="mt-3">
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="PlaceOrderAsync">Place Order</MudButton>
                        </MudStack>
                    </MudList>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="p-3 mb-3">
            <MudText Typo="Typo.h6">Recent Orders</MudText>

            <MudTable Items="_orders">
                <NoRecordsContent>
                    <MudText Color="Color.Secondary">No orders.</MudText>
                </NoRecordsContent>
                <HeaderContent>
                    <MudTh>Time</MudTh>
                    <MudTh>Symbol</MudTh>
                    <MudTh align="right">Qty</MudTh>
                    <MudTh align="right">Status</MudTh>
                    <MudTh align="right">Fill</MudTh>
                    <MudTh align="right">Type</MudTh>
                    <MudTh align="right">Limit</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.CreatedAt</MudTd>
                    <MudTd>@context.Symbol</MudTd>
                    <MudTd>@context.Quantity</MudTd>
                    <MudTd>@context.State</MudTd>
                    <MudTd>@context.FilledQuantity</MudTd>
                    <MudTd>@context.Type</MudTd>
                    <MudTd>@context.LimitPrice</MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No orders yet.</MudText>
                </NoRecordsContent>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>

        <MudPaper Class="p-3 mb-3">
            <MudText Typo="Typo.h6">Positions</MudText>
            <MudDivider Class="my-2" />
            <MudTable Items="_summary?.Positions ?? Array.Empty<PortfolioClient.PositionDto>()"
                      Dense="true" Hover="true" Bordered="true">
                <HeaderContent>
                    <MudTh>Symbol</MudTh>
                    <MudTh class="text-right">Qty</MudTh>
                    <MudTh class="text-right">Avg Cost</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Symbol">@context.Symbol</MudTd>
                    <MudTd DataLabel="Qty" Class="text-right">@context.Quantity</MudTd>
                    <MudTd DataLabel="Avg Cost" Class="text-right">@context.AvgCost</MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Class="pa-4" Typo="Typo.body2">No positions yet.</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudPaper>
    </MudItem>

    <!-- Right column: quotes -->
    <MudItem xxl="4" lg="4" md="12" sm="12">
        <MudPaper Class="p-3 mb-3">
            <MudText Class="mb-2" Color="Color.Secondary">Live prices (simulated)</MudText>

            <!--<MudChip T="string"
             Color="@(HubStatus.Connected ? Color.Success : Color.Error)"
             Variant="Variant.Outlined">
                @(HubStatus.Connected ? "Live" : "Disconnected")
            </MudChip>-->


            <MudTable Items="_quotes.Values.OrderBy(q => q.Symbol)" Dense="true" Hover="true" Class="mt-2">
                <HeaderContent>
                    <MudTh>Symbol</MudTh>
                    <MudTh>Bid</MudTh>
                    <MudTh>Ask</MudTh>
                    <MudTh>Last</MudTh>
                    <MudTh>Spread</MudTh>
                    <MudTh>Time</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Symbol</MudTd>
                    <MudTd>@context.Bid.ToString("0.####")</MudTd>
                    <MudTd>@context.Ask.ToString("0.####")</MudTd>
                    <MudTd>@(context.Last?.ToString("0.####") ?? "-")</MudTd>
                    <MudTd>@((context.Ask - context.Bid).ToString("0.####"))</MudTd>
                    <MudTd>@context.Ts.ToLocalTime().ToString("HH:mm:ss")</MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No quotes yet.</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudPaper>
    </MudItem>
</MudGrid>

@code
{
    private SummaryDto? _summary;
    private TradingClient.OrderDto[] _orders = Array.Empty <TradingClient.OrderDto>();

    private decimal _deposit;
    private bool _placing;

    private sealed class OrderForm
    {
        public string Symbol { get; set; } = "AAPL";
        public OrderSide Side { get; set; } = OrderSide.Buy;
        public OrderType Type { get; set; } = OrderType.Market;
        public decimal Quantity { get; set; } = 1m;
        public decimal? LimitPrice { get; set; }
    }
    private readonly OrderForm _form = new();

    private sealed class QuoteVm
    {
        public string Symbol { get; init; } = "";
        public decimal Bid { get; set; }
        public decimal Ask { get; set; }
        public decimal? Last { get; set; }
        public DateTimeOffset Ts { get; set; }
    }
    private readonly Dictionary<string, QuoteVm> _quotes = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaryAsync();
        await ReloadOrdersAsync();
    }

    private async Task LoadSummaryAsync()
    {
        _summary = await PortfolioClient.GetSummaryAsync();
        StateHasChanged();
    }

    private async Task ReloadOrdersAsync()
    {
        _orders = (await TradingClient.GetRecentAsync()).ToArray();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await Quotes.StartAsync();
        Quotes.OnQuote += msg =>
        {
            var sym = msg.Symbol.ToUpperInvariant();
            _quotes[sym] = new QuoteVm
            {
                Symbol = sym,
                Bid = msg.Bid,
                Ask = msg.Ask,
                Last = msg.Last,
                Ts = msg.Ts
            };
            _ = InvokeAsync(StateHasChanged);
        };
    }

    private async Task DepositAsync()
    {
        if (_deposit <= 0) return;
        await PortfolioClient.DepositAsync(_deposit, null);
        _deposit = 0;
        await LoadSummaryAsync();
    }

    private async Task PlaceOrderAsync()
    {
        _placing = true;
        try
        {
            var dto = new TradingClient.PlaceOrderDto(
                null,
                _form.Symbol,
                _form.Side,
                _form.Type,
                _form.Quantity,
                _form.Type == OrderType.Limit ? _form.LimitPrice : null);

            await TradingClient.PlaceAsync(dto);
            await ReloadOrdersAsync();
        }
        finally
        {
            _placing = false;
        }
    }

    private void OnTypeChanged(OrderType t)
    {
        _form.Type = t;
        if (t == OrderType.Market)
            _form.LimitPrice = null;
    }

    public async ValueTask DisposeAsync() => await Quotes.StopAsync();
}
