@page "/dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using MudBlazor
@using StockSim.Domain.Orders
@using StockSim.Web.Services
@using static StockSim.Web.Services.TradingClient
@using static StockSim.Web.Services.PortfolioClient
@inject PortfolioClient PortfolioClient
@inject TradingClient TradingClient
@inject QuotesHubClient Quotes

<MudSnackbarProvider />
<MudPopoverProvider />
<MudText Typo="Typo.h5">Portfolio Dashboard</MudText>

<MudGrid Class="mt-2" Spacing="3">
    <!-- LEFT COLUMN -->
    <MudItem xxl="8" lg="8" md="12" sm="12">
        <MudStack Spacing="3" Class="dashboard-left-stack">
            <!-- quotes under it -->
            <MudPaper Class="p-3 quotes-panel">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h6">Market Quotes</MudText>
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="RefreshQuotes">Refresh</MudButton>
                </MudStack>

                <MudTable T="QuoteRow"
                          Items="_quotes.Values.OrderBy(q => q.Symbol)"
                          Dense="true"
                          Hover="true"
                          Bordered="true"
                          OnRowClick="OnQuoteRowClick"
                          RowClassFunc="@( (q, index) => q.Symbol == _form.Symbol ? "selected-row" : null )"
                          Class="quotes-table">
                    <HeaderContent>
                        <MudTh>Symbol</MudTh>
                        <MudTh align="right">Last</MudTh>
                        <MudTh align="right">Ask</MudTh>
                        <MudTh align="right">Bid</MudTh>
                        <MudTh align="right">Change</MudTh>
                        <MudTh align="right">Change %</MudTh>
                        <MudTh align="right">Time</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Class="chip-symbol">@context.Symbol</MudChip>
                        </MudTd>

                        <MudTd align="right">
                            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Start" Spacing="1">
                                <MudIcon Size="Size.Small" Color="@DiffColor(context.Diff)" Icon="@DiffIcon(context.Diff)" />
                                <MudText Color="@DiffColor(context.Diff)">@context.Last.ToString("0.####")</MudText>
                            </MudStack>
                        </MudTd>

                        <MudTd align="right">
                            <MudText Color="Color.Info">@context.Ask.ToString("0.####")</MudText>
                        </MudTd>

                        <MudTd align="right">
                            <MudText Color="Color.Warning">@context.Bid.ToString("0.####")</MudText>
                        </MudTd>

                        <MudTd align="right">
                            <MudText Color="@DiffColor(context.Diff)">
                                @((context.Diff >= 0 ? "+" : "") + context.Diff.ToString("0.####"))
                            </MudText>
                        </MudTd>

                        <MudTd align="right">
                            <MudText Color="@DiffColor(context.Diff)">
                                @(((context.ChangePct >= 0 ? "+" : "") + context.ChangePct.ToString("0.##") + "%"))
                            </MudText>
                        </MudTd>

                        <MudTd align="right">
                            @context.UpdatedAt.ToLocalTime().ToString("HH:mm:ss")
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Color="Color.Secondary">Waiting for quotes...</MudText>
                    </NoRecordsContent>
                </MudTable>
                <MudText Color="Color.Secondary" Typo="Typo.caption">Tip: click a symbol to prefill the Trade form.</MudText>
            </MudPaper>           

            <!-- orders unchanged, just wrapped to look like a card -->
            <MudPaper Class="p-0 orders-panel">
                <MudStack Class="px-3 pt-3 pb-1" Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h6">Recent Orders</MudText>
                </MudStack>

                <MudTable Items="_orders" Dense="true" RowsPerPage="8"> 
                    <NoRecordsContent>
                        <MudText Color="Color.Secondary">No orders.</MudText>
                    </NoRecordsContent>
                    <HeaderContent>
                        <MudTh>Time</MudTh>
                        <MudTh>Symbol</MudTh>
                        <MudTh align="right">Qty</MudTh>
                        <MudTh align="right">Status</MudTh>
                        <MudTh align="right">Fill</MudTh>
                        <MudTh align="right">Type</MudTh>
                        <MudTh align="right">Limit</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy HH:mm:ss")</MudTd>
                        <MudTd>@context.Symbol</MudTd>
                        <MudTd align="right">@context.Quantity.ToString("0.####")</MudTd>
                        <MudTd align="right">@context.State</MudTd>
                        <MudTd align="right">@context.FilledQuantity.ToString("0.####")</MudTd>
                        <MudTd align="right">@context.Type</MudTd>
                        <MudTd align="right">@context.LimitPrice?.ToString("0.##")</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>No orders yet.</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudStack>
    </MudItem>

    <!-- RIGHT COLUMN -->
    <MudItem xxl="4" lg="4" md="12" sm="12">
        <MudStack Spacing="3" Class="dashboard-right-stack">
            <!-- account made compact -->
            <MudPaper Class="p-3 account-panel">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="3">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h6">Account</MudText>
                        <MudStack Row="true" Spacing="4" Class="account-metrics">
                            <MudText Color="Color.Primary">Cash: @(_summary?.Cash.ToString("0.##") ?? "-")</MudText>
                            <MudText Color="Color.Secondary">Reserved: @(_summary?.ReservedCash.ToString("0.##") ?? "-")</MudText>
                        </MudStack>
                    </MudStack>

                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="account-deposit">
                        <MudNumericField T="decimal" @bind-Value="_deposit" Min="0" Label="Deposit amount" Class="account-deposit-input" />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DepositAsync">Deposit</MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>
            <!-- trade goes first -->
            <MudPaper Class="p-3 trade-panel">
                <MudText Typo="Typo.h6" Class="mb-2">Trade</MudText>
                <MudForm>
                    <MudTextField T="string" @bind-Value="_form.Symbol" Label="Symbol" Required="true" />
                    <MudNumericField T="decimal" @bind-Value="_form.Quantity" Label="Quantity" Required="true" Min="0.0001m" />
                    <MudSelect T="OrderType"
                               Label="Type"
                               Value="_form.Type"
                               ValueChanged="OnTypeChanged"
                               ValueExpression="() => _form.Type">
                        <MudSelectItem Value="@(OrderType.Market)">Market</MudSelectItem>
                        <MudSelectItem Value="@(OrderType.Limit)">Limit</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="OrderSide" @bind-Value="_form.Side" Label="Side">
                        <MudSelectItem Value="@(OrderSide.Buy)">Buy</MudSelectItem>
                        <MudSelectItem Value="@(OrderSide.Sell)">Sell</MudSelectItem>
                    </MudSelect>

                    @if (_form.Type == OrderType.Limit)
                    {
                        <MudNumericField T="decimal?" @bind-Value="_form.LimitPrice" Label="Limit price" Min="0" />
                    }

                    <MudStack Row="true" Spacing="2" Class="mt-3">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PlaceOrderAsync" Disabled="@_placing">Place Order</MudButton>
                    </MudStack>
                </MudForm>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@code {
    private PortfolioClient.SummaryDto? _summary;
    private TradingClient.OrderDto[] _orders = Array.Empty <TradingClient.OrderDto>();

    // Trade form
    private readonly OrderForm _form = new()
    {
        Symbol = "AAPL",
        Quantity = 1m,
        Side = OrderSide.Buy,
        Type = OrderType.Market
    };
    private decimal _deposit;
    private bool _placing;

    // Quotes state
    private readonly Dictionary<string, QuoteRow> _quotes = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaryAsync();
        await ReloadOrdersAsync();

        StateHasChanged();
    }

    private async Task LoadSummaryAsync()
    {
        _summary = await PortfolioClient.GetSummaryAsync();
        StateHasChanged();
    }
    private async Task ReloadOrdersAsync()
    {
        _orders = (await TradingClient.GetRecentAsync()).ToArray();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await Quotes.StartAsync();
        Quotes.OnQuote += msg =>
        {
            OnQuoteReceived(msg);
            _ = InvokeAsync(StateHasChanged);
        };
    }

    // Example quote handler (call this from your hub callback)
    private void OnQuoteReceived(QuoteMsg msg)
    {
        // Quote is a placeholder DTO; adapt fields to your actual hub payload
        var symbol = msg.Symbol;
        var last = msg.Last ?? (msg.Bid + msg.Ask) / 2m;
        var existing = _quotes.GetValueOrDefault(msg.Symbol);
        var refPrice = existing?.RefPrice ?? last;

        if (_quotes.TryGetValue(symbol, out var row))
        {
            var prevLast = row.Last;
            row.Last = last;
            row.RefPrice = refPrice;
            row.Ask = msg.Ask;
            row.Bid = msg.Bid;
            row.Diff = last - refPrice;
            row.ChangePct = refPrice == 0 ? 0 : (row.Diff / refPrice) * 100m;
            row.UpdatedAt = msg.Ts;
        }
        else
        {
            _quotes[symbol] = new QuoteRow
            {
                Symbol = symbol,
                Last = last,
                RefPrice = refPrice,
                Ask = msg.Ask,
                Bid = msg.Bid,
                Diff = last - refPrice,
                ChangePct = refPrice == 0 ? 0 : ((last - refPrice) / refPrice) * 100m,
                UpdatedAt = msg.Ts
            };
        }

        InvokeAsync(StateHasChanged);
    }

    private void RefreshQuotes()
    {
        // optional: request a snapshot from the hub/service if supported
        // otherwise this button is a no-op placeholder
    }

    // Row selection -> populate Trade Symbol
    private void OnQuoteRowClick(TableRowClickEventArgs<QuoteRow> args)
    {
        _form.Symbol = args.Item.Symbol;
    }

    private static Color DiffColor(decimal diff) =>
        diff > 0 ? Color.Success : diff < 0 ? Color.Error : Color.Default;

    private static string DiffIcon(decimal diff) =>
        diff > 0 ? Icons.Material.Filled.ArrowDropUp :
        diff < 0 ? Icons.Material.Filled.ArrowDropDown :
                   Icons.Material.Filled.Remove;

    private async Task DepositAsync()
    {
        if (_deposit <= 0) return;
        await PortfolioClient.DepositAsync(_deposit, null);
        _deposit = 0;
        _summary = await PortfolioClient.GetSummaryAsync();
    }

    private async Task PlaceOrderAsync()
    {
        _placing = true;
        try
        {
            var dto = new TradingClient.PlaceOrderDto(
                null,
                _form.Symbol,
                _form.Side,
                _form.Type,
                _form.Quantity,
                _form.Type == OrderType.Limit ? _form.LimitPrice : null);

            await TradingClient.PlaceAsync(dto);
            await ReloadOrdersAsync();
            await LoadSummaryAsync();
        }
        finally
        {
            _placing = false;
        }
    }

    private void OnTypeChanged(OrderType t)
    {
        _form.Type = t;
        if (t == OrderType.Market) _form.LimitPrice = null;
    }

    private sealed class OrderForm
    {
        public string Symbol { get; set; } = "";
        public decimal Quantity { get; set; }
        public OrderSide Side { get; set; }
        public OrderType Type { get; set; }
        public decimal? LimitPrice { get; set; }
    }

    // UI row model for quotes
    private sealed class QuoteRow
    {
        public string Symbol { get; set; } = "";
        public decimal Last { get; set; }
        public decimal Ask { get; set; }
        public decimal Bid { get; set; }
        public decimal RefPrice { get; set; }  // previous close or first seen price
        public decimal Diff { get; set; }      // Last - RefPrice
        public decimal ChangePct { get; set; } // (Diff / RefPrice) * 100
        public DateTimeOffset UpdatedAt { get; set; }
    }

}